# PRD: 终端命令执行安全拦截机制 (Human-in-the-loop)

## 1. 简述
为 Agent 的终端工具增加安全拦截机制。当指令包含可能导致破坏性后果的危险命令时，系统将暂停操作并请求用户确认。这是构建安全、可控 AI 通信的关键防线。

## 2. 目标
- 识别危险终端命令。
- 在执行前强制挂起 Agent 循环并弹出用户确认 UI。
- 提供“本次运行始终允许”选项以优化高频操作体验。
- 允许用户在拒绝执行时反馈理由给 AI。

## 3. 用户故事 (User Stories)

### US-001: 危险命令识别规则配置
**描述**: 作为开发者，我希望在 `config.ts` 中配置危险命令的正则表达式，以便系统能识别它们。
**验收标准**:
- [ ] `IConfig` 接口中包含 `security.dangerousCommands` (string 数组，存储正则字符串)。
- [ ] 能够成功匹配 `rm -rf`, `git push`, `npm publish` 等典型危险指令。
- [ ] 类型检查通过。

### US-002: 执行前拦截与 UI 确认
**描述**: 作为用户，当 AI 尝试执行危险命令时，我希望看到一个确认弹窗，并能选择是否继续。
**验收标准**:
- [ ] `IRenderer` 接口扩展 `confirmAction` 方法。
- [ ] UI 弹出提示：“⚠️ AI 尝试执行危险命令: [命令]。是否允许？”。
- [ ] 提供三个选项：`允许 (Allow)`, `始终允许 (Always Allow for this session)`, `拒绝 (Deny)`。
- [ ] 选择“始终允许”后，在当前进程生命周期内不再对该命令正则进行拦截。

### US-003: 拒绝执行的反馈循环
**描述**: 作为用户，如果我拒绝了某个命令，我希望向 AI 提供反馈说明原因，引导它重新思考。
**验收标准**:
- [ ] 拒绝时 UI 允许输入文本。
- [ ] 如果用户输入了原因，终端回复给 AI 的结果应包含该原因。
- [ ] 如果用户未输入原因，默认返回 "User denied the execution for security reasons."

## 4. 功能需求 (Functional Requirements)
- **FR-1**: 在 `TerminalTool.execute` 之前注入拦截检查逻辑。
- **FR-2**: 使用正则表达式匹配命令全文。
- **FR-3**: 拦截逻辑必须是异步的，能够阻塞 Agent 的 `Loop` 直到用户输入。
- **FR-4**: 维护一个内存中的 `allowedPatterns` 集合，用于处理“始终允许”。

## 5. 非功能需求 (Non-Goals)
- 不处理终端内的交互式命令（如 `vim`）。
- 不提供全局/永久的“危险命令白名单”持久化，仅限进程级。

## 6. 技术方案建议
- **配置**: 修改 `src/types/config.ts`。
- **UI**: 在 `src/types/ui.ts` 增加 `confirmAction` 接口。
- **工具**: 在 `TerminalTool` 或其代理层实现拦截逻辑。

## 7. 开放问题
- 是否需要对危险等级进行分级（如“强制拦截” vs “仅警告”）？（当前暂定全部拦截）。
